<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z-Rede | Instagram Clone</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Vari√°veis e Reset (Design Instagram-Like) */
        :root {
            --bg-body: #FAFAFA; /* Fundo muito claro */
            --bg-card: #FFFFFF; /* Fundo dos elementos */
            --border-color: #DBDBDB; /* Borda clara e sutil */
            --text-primary: #262626; /* Texto quase preto */
            --text-secondary: #8E8E8E; /* Texto cinza */
            --accent-color: #0095F6; /* Azul Instagram */
            --accent-danger: #ED4956; /* Vermelho like */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 14px;
        }

        /* Cont√™iner Principal */
        #app-container {
            width: 100%;
            max-width: 480px; /* Largura mais estreita, como o Instagram */
            min-height: 100vh;
            position: relative;
            background-color: var(--bg-body);
        }

        /* Header Fixo (Topo) */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 54px;
        }
        .logo { 
            font-family: sans-serif; 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--text-primary);
        }

        /* Autentica√ß√£o/Login */
        .auth-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 54px);
            padding: 2rem;
        }
        .auth-box {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 2.5rem 1.5rem;
            width: 100%;
            max-width: 350px;
            text-align: center;
        }
        .auth-title { font-size: 1.8rem; margin-bottom: 1.5rem; }
        input[type="email"] {
            width: 100%;
            background: #FAFAFA;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            outline: none;
            margin-bottom: 0.5rem;
        }
        .btn {
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary { 
            background-color: var(--accent-color); 
            color: white; 
            width: 100%; 
            margin-top: 0.5rem;
        }
        .btn-primary:disabled { background-color: rgba(0, 149, 246, 0.5); }

        /* Composi√ß√£o/Postagem */
        .compose-area {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-card);
        }
        .compose-input {
            width: 100%;
            border: 1px solid var(--border-color);
            background-color: #FAFAFA;
            resize: none;
            font-size: 1rem;
            min-height: 80px;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        .btn-post {
            background-color: var(--accent-color); 
            color: white; 
            float: right;
        }

        /* Feed Post */
        .post-card {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .post-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
        }
        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 0.75rem;
            border: 2px solid var(--accent-color); /* Borda sutil de perfil */
            padding: 1px;
        }
        .username {
            font-weight: 600;
            color: var(--text-primary);
        }
        .post-image {
            width: 100%;
            max-height: 480px;
            object-fit: cover;
            display: block;
        }
        .post-actions {
            padding: 0.5rem 1rem;
            display: flex;
            gap: 1rem;
        }
        .action-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .liked { color: var(--accent-danger); }

        .post-details {
            padding: 0 1rem 1rem 1rem;
        }
        .likes-count { font-weight: 600; margin-bottom: 0.2rem; }
        .post-caption { margin-bottom: 0.5rem; }
        .post-time { color: var(--text-secondary); font-size: 0.7rem; margin-top: 0.5rem; }
        .status-msg { margin-top: 1rem; padding: 0.75rem; border-radius: 4px; width: 100%; text-align: center;}
        .status-error { background-color: #F8D7DA; color: #721C24; border: 1px solid #F5C6CB;}
        .status-success { background-color: #D4EDDA; color: #155724; border: 1px solid #C3E6CB;}
        .loader { text-align: center; padding: 2rem; color: var(--accent-color); font-size: 1.5rem;}
    </style>
</head>
<body>

    <div id="app-container">
        </div>

    <script>
        // =========================================================
        // !!! CREDENCIAIS SUPABASE ATUALIZADAS !!!
        // =========================================================
        const SUPABASE_URL = 'https://qzerbrzpfvuhoaitbnlw.supabase.co'; 
        const SUPABASE_ANON_KEY = 'sb_publishable_bFIvUUsgTVClHVRs6yciag_jSvo1jjL';
        
        // URL de Redirecionamento
        const SITE_URL = 'https://z-rede.vercel.app'; 
        
        let supabaseClient;
        let currentSession = null;
        let currentProfile = null;

        try {
            // Inicializa o cliente Supabase com as novas chaves
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (err) {
            document.getElementById('app-container').innerHTML = "<h1 style='color:red; padding: 20px; text-align:center;'>ERRO: Falha ao inicializar Supabase. Verifique as chaves.</h1>";
        }

        const appContainer = document.getElementById('app-container');

        async function initApp() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentSession = session;
            if (currentSession) {
                await fetchCurrentProfile();
            }
            route();
            supabaseClient.auth.onAuthStateChange(async (_event, session) => {
                currentSession = session;
                if (session) {
                    await fetchCurrentProfile();
                } else {
                    currentProfile = null;
                }
                route();
            });
        }

        async function fetchCurrentProfile() {
            if (currentSession) {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('id, username, full_name, avatar_url, bio')
                    .eq('id', currentSession.user.id)
                    .single();
                
                if (data) currentProfile = data;
                if (error) console.error("Erro ao buscar perfil atual:", error);
            }
        }

        function route() {
            currentSession ? renderFeedUI() : renderAuthUI();
        }

        // --- UI de Autentica√ß√£o ---
        function renderAuthUI() {
            appContainer.innerHTML = `
                <div class="auth-wrapper">
                    <div class="auth-box">
                        <div class="logo" style="font-size: 2.2rem; margin-bottom: 2rem;">Z-Rede</div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">Entre com seu e-mail para acesso.</p>
                        <input type="email" id="email-input" placeholder="E-mail">
                        <button class="btn btn-primary" onclick="handleLogin()">Entrar com Link M√°gico</button>
                        <div id="auth-status" class="status-msg" style="display:none;"></div>
                    </div>
                </div>
            `;
        }
        
        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const statusEl = document.getElementById('auth-status');
            
            if (!email || !email.includes('@')) {
                statusEl.style.display = 'block';
                statusEl.className = 'status-msg status-error';
                statusEl.innerHTML = 'Por favor, insira um e-mail v√°lido.';
                return;
            }

            statusEl.style.display = 'block';
            statusEl.className = 'status-msg';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando link...';

            const { error } = await supabaseClient.auth.signInWithOtp({
                email: email,
                options: { emailRedirectTo: SITE_URL }
            });

            if (error) {
                statusEl.className = 'status-msg status-error';
                statusEl.innerHTML = `Erro: ${error.message}`;
            } else {
                statusEl.className = 'status-msg status-success';
                statusEl.innerHTML = 'Link enviado! Verifique seu e-mail.';
            }
        }

        // --- UI do Feed Principal ---
        function renderFeedUI() {
            const username = currentProfile?.username || 'Carregando...';
            const avatar = currentProfile?.avatar_url || `https://ui-avatars.com/api/?name=Z&background=0095F6&color=fff&size=36`;

            appContainer.innerHTML = `
                <div class="sticky-header">
                    <div class="logo">Z-Rede</div>
                    <div style="display:flex; gap: 10px;">
                        <button class="action-btn" onclick="renderSearchUI()" title="Pesquisar"><i class="fas fa-search"></i></button> 
                        <button class="action-btn" onclick="renderProfileUI(currentProfile.id)" title="Meu Perfil">
                             <img src="${avatar}" class="avatar" style="width: 24px; height: 24px; padding: 0; border: none;">
                        </button>
                        <button class="action-btn" onclick="supabaseClient.auth.signOut()" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>

                <div id="main-content">
                    <div class="compose-area">
                        <textarea id="post-input" class="compose-input" placeholder="O que voc√™ est√° pensando?" oninput="togglePostButton()"></textarea>
                        <input type="file" id="image-upload" accept="image/*" style="display: block; margin-bottom: 0.5rem; font-size: 0.8rem;">
                        <button id="post-btn" class="btn btn-post" onclick="handlePostWithImage()" disabled>Postar</button>
                        <div style="clear: both;"></div>
                    </div>
                    <div id="feed-container">
                        <div class="loader"><i class="fas fa-circle-notch fa-spin"></i> Carregando Feed...</div>
                    </div>
                </div>
            `;
            loadFeed();
        }

        function togglePostButton() {
            const input = document.getElementById('post-input');
            const image = document.getElementById('image-upload');
            document.getElementById('post-btn').disabled = !(input?.value.trim() || image?.files.length > 0);
        }

        // ------------------------------------------
        // L√ìGICA DE DADOS
        // ------------------------------------------
        
        // üî¥ PLACEHOLDER DE UPLOAD EXTERNO
        async function uploadImageToExternalService(file) {
            if (!file) return null;
            console.warn("Usando upload simulado. Implemente a integra√ß√£o real!");
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            return "https://picsum.photos/480/480?" + Math.random(); 
        }

        async function handlePostWithImage() {
            const content = document.getElementById('post-input').value;
            const imageFile = document.getElementById('image-upload').files[0];
            const postBtn = document.getElementById('post-btn');
            
            if (!content.trim() && !imageFile) return;

            postBtn.disabled = true;

            let imageUrl = null;
            try {
                if (imageFile) {
                    imageUrl = await uploadImageToExternalService(imageFile); 
                    if (!imageUrl) throw new Error("Falha ao obter URL da imagem.");
                }

                const { error } = await supabaseClient
                    .from('posts')
                    .insert({ 
                        content: content, 
                        user_id: currentSession.user.id,
                        image_url: imageUrl
                    });

                if (error) throw error;
                
                document.getElementById('post-input').value = '';
                document.getElementById('image-upload').value = ''; 
                togglePostButton();
                loadFeed(); // Recarrega o feed para mostrar o novo post
                
            } catch (error) {
                alert("Erro ao postar: " + error.message);
                postBtn.disabled = false;
            }
        }

        async function loadFeed() {
            const container = document.getElementById('feed-container');
            const { data: posts, error } = await supabaseClient
                .from('posts')
                .select(`
                    *, 
                    profiles(username, avatar_url, full_name, is_verified),
                    likes(user_id)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                container.innerHTML = `<div class="status-msg status-error">Erro ao carregar feed: ${error.message}</div>`;
                return;
            }

            container.innerHTML = posts.map(post => {
                const user = post.profiles;
                const liked = post.likes.some(like => like.user_id === currentSession.user.id);
                const likesCount = post.likes.length;

                return `
                <div class="post-card" data-post-id="${post.id}">
                    <div class="post-header" onclick="renderProfileUI('${user.id}')" style="cursor:pointer;">
                        <img src="${user.avatar_url}" class="avatar" alt="${user.username}">
                        <div>
                            <span class="username">${user.username} ${user.is_verified ? '<i class="fas fa-check-circle" style="color: var(--accent-color); font-size: 0.8rem;"></i>' : ''}</span>
                        </div>
                    </div>

                    ${post.image_url ? `<img src="${post.image_url}" class="post-image" alt="Post Image">` : ''}

                    <div class="post-actions">
                        <button class="action-btn" onclick="toggleLike('${post.id}', ${liked})">
                            <i class="fas fa-heart ${liked ? 'liked' : ''}"></i>
                        </button>
                        <button class="action-btn" onclick="alert('Funcionalidade de Coment√°rios n√£o implementada na UI r√°pida. ID do Post: ${post.id}')">
                            <i class="far fa-comment"></i>
                        </button>
                    </div>

                    <div class="post-details">
                        <div class="likes-count">${likesCount} curtidas</div>
                        ${post.content ? `<div class="post-caption"><span class="username">${user.username}</span> ${escapeHtml(post.content)}</div>` : ''}
                        <div class="post-time">${timeDiff(new Date(post.created_at))}</div>
                    </div>
                </div>
                `;
            }).join('') || `<div style="padding:40px; text-align:center; color:var(--text-secondary)">Seja o primeiro a postar!</div>`;
        }

        async function toggleLike(postId, currentlyLiked) {
            const userId = currentSession.user.id;
            
            if (currentlyLiked) {
                await supabaseClient.from('likes').delete().match({ user_id: userId, post_id: postId });
            } else {
                await supabaseClient.from('likes').insert({ user_id: userId, post_id: postId });
            }
            // Recarrega o feed para atualizar a contagem
            loadFeed(); 
        }

        // ------------------------------------------
        // L√ìGICA DE PERFIL/PESQUISA (Exemplos de chamadas)
        // ------------------------------------------

        async function renderProfileUI(profileId) {
            const targetId = profileId || currentProfile.id;

            const { data: profile, error } = await supabaseClient
                .from('profiles')
                .select(`
                    *, 
                    posts(id), 
                    followers!followers_following_id_fkey(follower_id), 
                    following:followers!followers_follower_id_fkey(following_id)
                `)
                .eq('id', targetId)
                .single();
            
            if (error || !profile) {
                alert('Perfil n√£o encontrado: ' + (error ? error.message : ''));
                return;
            }

            const isOwnProfile = targetId === currentProfile.id;
            const isFollowing = profile.followers.some(f => f.follower_id === currentProfile.id);
            
            document.getElementById('main-content').innerHTML = `
                <div style="padding: 1rem; background-color: var(--bg-card);">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <img src="${profile.avatar_url}" class="avatar" style="width: 80px; height: 80px; margin: 0 auto; padding: 2px;">
                        <h2 class="username" style="font-size: 1.2rem; margin-top: 0.5rem;">${profile.username} ${profile.is_verified ? '<i class="fas fa-check-circle" style="color: var(--accent-color); font-size: 0.8rem;"></i>' : ''}</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">${profile.full_name || ''}</p>
                        <p>${profile.bio || 'Nenhuma biografia ainda.'}</p>
                    </div>

                    <div style="display: flex; justify-content: space-around; text-align: center; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 0.5rem 0; margin-bottom: 1rem;">
                        <div><span style="font-weight: 600;">${profile.posts.length}</span> posts</div>
                        <div><span style="font-weight: 600;">${profile.followers.length}</span> seguidores</div>
                        <div><span style="font-weight: 600;">${profile.following.length}</span> seguindo</div>
                    </div>
                    
                    <div style="text-align: center;">
                        ${isOwnProfile ? 
                            `<button class="btn" style="background: #EFEFEF; color: var(--text-primary);" onclick="alert('Abrir tela de edi√ß√£o de perfil')">Editar Perfil</button>` :
                            `<button class="btn btn-primary" onclick="toggleFollow('${profile.id}', ${isFollowing})" style="width: 80%; max-width: 300px; background: ${isFollowing ? '#EFEFEF' : 'var(--accent-color)'}; color: ${isFollowing ? 'var(--text-primary)' : 'white'};">
                                ${isFollowing ? 'Seguindo' : 'Seguir'}
                            </button>`
                        }
                        <button class="btn" style="background: none; color: var(--text-secondary); margin-top: 1rem; display:block; width: 100%;" onclick="loadFeed()">Voltar ao Feed</button>
                    </div>
                </div>
            `;
        }

        async function toggleFollow(targetId, isFollowing) {
            const userId = currentSession.user.id;
            if (isFollowing) {
                await supabaseClient.from('followers').delete().match({ follower_id: userId, following_id: targetId });
            } else {
                await supabaseClient.from('followers').insert({ follower_id: userId, following_id: targetId });
            }
            renderProfileUI(targetId); // Recarrega a UI do perfil
        }

        async function renderSearchUI() {
            // Este √© apenas o front-end da pesquisa. A chamada de dados fica em outra fun√ß√£o.
            document.getElementById('main-content').innerHTML = `
                <div style="padding: 1rem; background-color: var(--bg-card); border-bottom: 1px solid var(--border-color);">
                    <input type="text" id="search-input" placeholder="Pesquisar usu√°rios por @username" style="width: 100%; padding: 10px; border: 1px solid #DBDBDB; border-radius: 4px;" oninput="searchUsers(this.value)">
                </div>
                <div id="search-results" style="padding: 1rem;">
                    <p style="color: var(--text-secondary); text-align: center;">Comece a digitar para encontrar usu√°rios.</p>
                </div>
                <button class="btn" style="background: none; color: var(--text-secondary); margin-top: 1rem; display:block; width: 100%;" onclick="loadFeed()">Voltar ao Feed</button>
            `;
        }

        async function searchUsers(query) {
            const resultsDiv = document.getElementById('search-results');
            if (query.length < 3) {
                resultsDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Digite pelo menos 3 caracteres.</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="loader"><i class="fas fa-circle-notch fa-spin"></i> Buscando...</div>';

            const { data, error } = await supabaseClient
                .from('profiles')
                .select('id, username, avatar_url, full_name')
                .ilike('username', `%${query}%`) // Usa ilike para pesquisa n√£o sens√≠vel a mai√∫sculas/min√∫sculas
                .limit(10);

            if (error) {
                resultsDiv.innerHTML = `<div class="status-msg status-error">Erro na pesquisa: ${error.message}</div>`;
                return;
            }

            if (data.length === 0) {
                resultsDiv.innerHTML = `<p style="color: var(--text-secondary); text-align: center;">Nenhum usu√°rio encontrado com "@${query}".</p>`;
                return;
            }

            resultsDiv.innerHTML = data.map(user => `
                <div style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #EFEFEF; cursor: pointer;" onclick="renderProfileUI('${user.id}')">
                    <img src="${user.avatar_url}" class="avatar" style="width: 40px; height: 40px; margin-right: 1rem; padding: 0; border: 1px solid #C7C7C7;">
                    <div>
                        <span class="username">${user.username}</span>
                        <p style="color: var(--text-secondary); font-size: 0.8rem;">${user.full_name || ''}</p>
                    </div>
                </div>
            `).join('');
        }

        // Fun√ß√µes Utilit√°rias
        function timeDiff(date) {
            const diffMin = Math.floor((new Date() - date) / 60000);
            if (diffMin < 1) return 'agora';
            if (diffMin < 60) return `${diffMin}m`;
            if (diffMin < 1440) return `${Math.floor(diffMin / 60)}h`;
            return date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Iniciar a aplica√ß√£o
        initApp();
    </script>
</body>
</html>
