<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>InstaClone Pro</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <style>
    /* --- CSS GERAL --- */
    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Inter', sans-serif; }
    
    body {
      background-color: #000;
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* --- TELAS (SPA) --- */
    .screen { display: none; padding-bottom: 70px; width: 100%; max-width: 500px; margin: 0 auto; }
    .active-screen { display: block; }

    /* --- AUTH SCREEN (LOGIN/CADASTRO) --- */
    #auth-screen {
      height: 100vh;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      text-align: center;
      background: linear-gradient(135deg, #1a1a1a, #000);
    }

    .auth-box {
      width: 100%;
      max-width: 350px;
    }

    .logo {
      font-family: 'Segoe UI', cursive;
      font-size: 3rem;
      margin-bottom: 30px;
      background: linear-gradient(90deg, #FF7D05F7, #7f00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .auth-input {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      background: #333;
      border: 1px solid #444;
      border-radius: 5px;
      color: white;
    }

    .btn-primary {
      width: 100%;
      padding: 15px;
      background: #0095f6;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }

    .toggle-auth {
      margin-top: 20px;
      color: #aaa;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .toggle-auth span { color: #0095f6; font-weight: bold; }

    /* --- HEADER & NAV --- */
    header {
      padding: 15px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #000;
      z-index: 100;
    }

    .header-logo { font-family: 'Segoe UI', cursive; font-size: 1.5rem; }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #000;
      border-top: 1px solid #333;
      display: flex;
      justify-content: space-around;
      padding: 15px 0;
      z-index: 200;
    }

    .nav-btn { font-size: 1.5rem; color: #fff; cursor: pointer; background: none; border: none; }
    .nav-btn.active { color: #FF7D05F7; }

    /* --- FEED --- */
    .post-card { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; }
    .post-header { padding: 10px; display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 30px; height: 30px; border-radius: 50%; background: #444; object-fit: cover;}
    .post-img { width: 100%; height: auto; max-height: 500px; object-fit: cover; }
    .post-actions { padding: 10px; display: flex; gap: 15px; font-size: 1.5rem; }
    .post-caption { padding: 0 10px; }
    
    /* --- PERFIL --- */
    .profile-header { padding: 20px; display: flex; align-items: center; gap: 20px; }
    .profile-pic-lg { width: 80px; height: 80px; border-radius: 50%; background: #333; object-fit: cover; border: 2px solid #FF7D05F7; }
    .profile-stats { flex: 1; }
    .profile-name { font-size: 1.2rem; font-weight: bold; display: block; }
    .btn-logout { background: #333; color: white; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; margin-top: 5px; cursor: pointer; font-size: 0.8rem;}
    
    .profile-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
    .grid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer;}

    /* --- BUSCA --- */
    .search-container { padding: 10px; }
    .search-bar { width: 100%; padding: 10px; background: #262626; border: none; border-radius: 8px; color: white; }
    .user-list-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #222; cursor: pointer; }
    
    /* --- MODAL UPLOAD --- */
    .upload-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 300; display: none; justify-content: center; align-items: center; flex-direction: column;}
    .upload-box { 
        background: #222; 
        padding: 20px; 
        border-radius: 10px; 
        width: 90%; 
        max-width: 400px; 
        text-align: center; 
        position: relative;
        z-index: 5;
    }
    
    /* Garante que o <a> estilizado se comporte como botão */
    .btn-primary-link {
        width: 100%;
        padding: 15px;
        background: #0095f6;
        border: none;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        margin-top: 10px;
        text-decoration: none;
        display: block;
        text-align: center;
        position: relative;
        z-index: 10;
    }
  </style>
</head>
<body>

  <div id="auth-screen">
    <div class="auth-box">
      <h1 class="logo">InstaClone</h1>
      
      <div id="login-form">
        <input type="email" id="login-email" class="auth-input" placeholder="E-mail">
        <input type="password" id="login-password" class="auth-input" placeholder="Senha">
        <button class="btn-primary" onclick="handleLogin()">Entrar</button>
        <p class="toggle-auth" onclick="toggleAuth('register')">Não tem uma conta? <span>Cadastre-se</span></p>
      </div>

      <div id="register-form" style="display: none;">
        <input type="text" id="reg-username" class="auth-input" placeholder="Nome de Usuário (ex: joao123)">
        <input type="email" id="reg-email" class="auth-input" placeholder="E-mail">
        <input type="password" id="reg-password" class="auth-input" placeholder="Senha">
        <button class="btn-primary" onclick="handleRegister()">Cadastrar</button>
        <p class="toggle-auth" onclick="toggleAuth('login')">Já tem conta? <span>Entrar</span></p>
      </div>
    </div>
  </div>

  <div id="app-screen" style="display: none;">
    
    <header>
      <div class="header-logo">InstaClone</div>
      <button onclick="openUpload()" style="background:none; border:none; color:white; font-size:1.5rem;"><i class="far fa-plus-square"></i></button>
    </header>

    <div id="screen-home" class="screen active-screen">
      </div>

    <div id="screen-search" class="screen">
      <div class="search-container">
        <input type="text" class="search-bar" placeholder="Pesquisar usuários..." oninput="searchUsers(this.value)">
        <div id="search-results"></div>
      </div>
    </div>

    <div id="screen-profile" class="screen">
      <div class="profile-header">
        <img src="https://via.placeholder.com/150" id="p-avatar" class="profile-pic-lg">
        <div class="profile-stats">
          <span class="profile-name" id="p-username">Carregando...</span>
          <div style="margin: 10px 0;">
            <strong id="p-posts-count">0</strong> publicações
          </div>
          <button class="btn-logout" id="btn-logout-action" onclick="logout()">Sair</button>
        </div>
      </div>
      <div class="profile-grid" id="profile-posts-grid"></div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-btn active" onclick="navTo('home')"><i class="fas fa-home"></i></button>
      <button class="nav-btn" onclick="navTo('search')"><i class="fas fa-search"></i></button>
      <button class="nav-btn" onclick="navTo('profile')"><i class="fas fa-user"></i></button>
    </nav>

    <div class="upload-modal" id="modalUpload">
      <div class="upload-box">
        <h3>Nova Publicação</h3>
        <input type="file" id="fileInput" class="auth-input" accept="image/*" style="margin-top:15px;">
        <input type="text" id="captionInput" class="auth-input" placeholder="Legenda...">
        
        <a href="javascript:void(0)" id="btn-share-post" class="btn-primary-link">Compartilhar</a>
        
        <button style="background:transparent; border:none; color:red; margin-top:10px; cursor:pointer;" onclick="closeUpload()">Cancelar</button>
      </div>
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ================= CONFIGURAÇÃO DO FIREBASE =================
    const firebaseConfig = {
      apiKey: "AIzaSyCHpunrtbhlIvLEev6fkZDNRvTieEQt1Hg",
      authDomain: "sske-9ff9f.firebaseapp.com",
      databaseURL: "https://sske-9ff9f-default-rtdb.firebaseio.com",
      projectId: "sske-9ff9f",
      storageBucket: "sske-9ff9f.firebasestorage.app",
      messagingSenderId: "464070910654",
      appId: "1:464070910654:web:b8b87b1835fe309630f4ef"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.database();
    
    let currentUserData = null; 

    // ================= SISTEMA DE AUTH =================
    
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        
        db.ref('users/' + user.uid).once('value').then(snap => {
          currentUserData = snap.val();
          loadFeed(); 
        }).catch(error => {
            alert("❌ ERRO AO CARREGAR DADOS DO PERFIL (USERS): " + error.message);
            loadFeed(); 
        });

      } else {
        document.getElementById('auth-screen').style.display = 'flex';
        document.getElementById('app-screen').style.display = 'none';
      }
    });

    function toggleAuth(type) {
      if(type === 'register') {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
      } else {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('register-form').style.display = 'none';
      }
    }

    async function handleRegister() {
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const username = document.getElementById('reg-username').value.trim().toLowerCase();

        if(!username) return alert("Digite um nome de usuário");
        if(password.length < 6) return alert("A senha deve ter pelo menos 6 caracteres.");

        try {
            const userCred = await auth.createUserWithEmailAndPassword(email, password);
            const uid = userCred.user.uid;

            await db.ref('users/' + uid).set({
                username: username,
                email: email,
                uid: uid,
                profilePic: `https://ui-avatars.com/api/?name=${username}&background=random`
            });

            alert("✅ SUCESSO! Conta criada.");
        } catch (error) {
            alert("❌ ERRO NO CADASTRO: " + error.message);
        }
    }

    function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      auth.signInWithEmailAndPassword(email, password)
        .catch(error => alert("❌ ERRO AO FAZER LOGIN: " + error.message));
    }

    function logout() {
      auth.signOut();
    }

    // ================= NAVEGAÇÃO =================
    function navTo(screenName) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active-screen'));
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

      document.getElementById('screen-' + screenName).classList.add('active-screen');
      
      const btnIndex = screenName === 'home' ? 0 : screenName === 'search' ? 1 : 2;
      document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');

      if(screenName === 'profile') loadProfile(auth.currentUser ? auth.currentUser.uid : null);
      if(screenName === 'home') loadFeed(); // Garante que o feed recarregue ao navegar
    }

    // ================= FEED & POSTS =================
    function loadFeed() {
      const feedDiv = document.getElementById('screen-home');
      // Limpa e mostra carregando
      feedDiv.innerHTML = '<p style="text-align:center; padding-top: 20px;">A carregar publicações...</p>';
      
      db.ref('posts').off(); 

      // Usa .on para escutar mudanças em tempo real
      db.ref('posts').limitToLast(50).on('value', (snapshot) => {
        feedDiv.innerHTML = '';
        const posts = [];
        snapshot.forEach(child => posts.push({id: child.key, ...child.val()}));
        posts.reverse(); 
        
        if(posts.length === 0) {
           feedDiv.innerHTML = '<p style="text-align:center; padding-top: 50px; color:#555;">Não há publicações no feed.</p>';
           return;
        }

        posts.forEach(post => {
          db.ref('users/' + post.uid).once('value').then(uSnap => {
            const user = uSnap.val() || { username: 'Desconhecido', profilePic: 'https://via.placeholder.com/30' };
            
            const html = `
              <div class="post-card">
                <div class="post-header" onclick="viewUserProfile('${post.uid}')" style="cursor:pointer">
                  <img src="${user.profilePic}" class="user-avatar">
                  <strong>${user.username}</strong>
                </div>
                <img src="${post.imageUrl}" class="post-img" ondblclick="likePost('${post.id}')">
                <div class="post-actions">
                  <i class="far fa-heart" onclick="likePost('${post.id}')"></i>
                </div>
                <div class="post-caption">
                  <strong>${post.likes || 0} curtidas</strong><br>
                  <span style="font-weight:bold; margin-right:5px;">${user.username}</span> ${post.caption}
                </div>
              </div>
            `;
            feedDiv.innerHTML += html;
          });
        });
      }, (error) => {
          alert("❌ ERRO AO CARREGAR FEED: " + error.message + " (Regras de Leitura 'posts' falharam!)");
          feedDiv.innerHTML = '<p style="text-align:center; padding-top: 50px; color:red;">FALHA AO CARREGAR. Verifique as regras do Firebase.</p>';
      });
    }

    function likePost(postId) {
      db.ref(`posts/${postId}/likes`).transaction(likes => (likes || 0) + 1);
    }

    // ================= UPLOAD DE FOTO (CORREÇÃO FINAL DE FLUXO E CONGELAMENTO) =================
    function openUpload() { 
        if (!auth.currentUser) {
            return alert("❌ Você precisa estar logado para abrir o uploader.");
        }
        document.getElementById('modalUpload').style.display = 'flex'; 
    }
    function closeUpload() { document.getElementById('modalUpload').style.display = 'none'; }

    async function uploadPost() {
        const fileInput = document.getElementById('fileInput');
        const caption = document.getElementById('captionInput').value;
        
        if (!auth.currentUser) {
            return alert("❌ ERRO: Você precisa estar logado para postar!");
        }

        if(!fileInput.files[0]) {
            return alert("❌ ERRO: Nenhum arquivo de imagem foi selecionado.");
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);
        
        alert("✅ INICIANDO UPLOAD: Revertendo para ImgBB. Aguarde a resposta do servidor...");
        
        const IMGBB_API_KEY = '599411b1c02c7129d1b0da9bd4634c09'; 

        try {
            // Envio da imagem: Usamos .then() para evitar que o await do fetch congele a UI
            fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST', 
                body: formData,
            })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => { 
                        throw new Error(`Falha Status: ${res.status}. Resposta: ${text.substring(0, 50)}...`); 
                    });
                }
                return res.json();
            })
            .then(async data => { // Usando async aqui para poder usar await no Firebase
                const imageUrl = data.data && data.data.url; 
                
                if (data.success && imageUrl) {
                    // FASE CRÍTICA: SALVANDO NO FIREBASE com await
                    try {
                        await db.ref('posts').push({
                            uid: auth.currentUser.uid,
                            imageUrl: imageUrl, 
                            caption: caption,
                            likes: 0,
                            timestamp: Date.now()
                        });

                        // FINALIZAÇÃO: Fecha o modal, força a navegação para Home e avisa
                        closeUpload();
                        navTo('home'); 
                        alert("✅ SUCESSO FINAL: Postagem completa e feed atualizado!");
                        

                    } catch (e) {
                        alert("❌ ERRO AO SALVAR POST NO FIREBASE: " + e.message);
                    }

                } else {
                    // Erros do ImgBB
                    alert('❌ ERRO NO UPLOAD DA IMAGEM (ImgBB): ' + (data.error ? data.error.message : 'Resposta inválida.'));
                }
            })
            .catch(e => {
                // Erros de rede ou CORS
                alert('❌ ERRO GERAL NO UPLOAD (FATAL): ' + e.message);
            });

        } catch (e) {
            // Erro de lógica (muito improvável)
            alert('❌ ERRO GERAL NO UPLOAD (FATAL - CATCH EXTERNO): ' + e.message);
        }
    }


    // ================= BUSCA DE USUÁRIOS =================
    function searchUsers(query) {
      const resultsDiv = document.getElementById('search-results');
      resultsDiv.innerHTML = '';
      if(query.length < 2) return;

      query = query.toLowerCase();

      db.ref('users').orderByChild('username').startAt(query).endAt(query + "\uf8ff")
        .once('value', snapshot => {
          snapshot.forEach(child => {
            const u = child.val();
            const html = `
              <div class="user-list-item" onclick="viewUserProfile('${u.uid}')">
                <img src="${u.profilePic}" class="user-avatar">
                <span>${u.username}</span>
              </div>
            `;
            resultsDiv.innerHTML += html;
          });
        }, (error) => {
            alert("❌ ERRO NA BUSCA: " + error.message + " (Verifique a regra .indexOn: 'username'!)");
        });
    }

    // ================= PERFIL =================
    function viewUserProfile(uid) {
      loadProfile(uid);
      navTo('profile');
      
      const isMe = auth.currentUser && uid === auth.currentUser.uid;
      document.getElementById('btn-logout-action').style.display = isMe ? 'block' : 'none';
    }

    function loadProfile(uid) {
      if (!uid) {
          return document.getElementById('p-username').innerText = "Erro: Faça Login";
      }

      // 1. Carrega dados do usuário
      db.ref('users/' + uid).once('value', snap => {
        const u = snap.val();
        if (u) {
            document.getElementById('p-username').innerText = u.username;
            document.getElementById('p-avatar').src = u.profilePic;
        } else {
            document.getElementById('p-username').innerText = "Usuário não encontrado";
        }
      });

      // 2. Carrega posts DESSE usuário
      const grid = document.getElementById('profile-posts-grid');
      grid.innerHTML = '<p style="padding:10px">Carregando posts...</p>';
      
      db.ref('posts').orderByChild('uid').equalTo(uid).once('value', snap => {
        grid.innerHTML = '';
        const posts = [];
        snap.forEach(c => posts.push(c.val()));
        posts.reverse();
        
        document.getElementById('p-posts-count').innerText = posts.length;

        posts.forEach(p => {
          grid.innerHTML += `<img src="${p.imageUrl}" class="grid-img">`;
        });
        
        if(posts.length === 0) grid.innerHTML = '<p style="padding:20px; grid-column:span 3; text-align:center; color:#555">Sem publicações.</p>';
      });
    }


    // ================= REGISTRO DE EVENTO (CORREÇÃO FINAL DO CLIQUE) =================
    document.addEventListener('DOMContentLoaded', () => {
        const shareButton = document.getElementById('btn-share-post');
        if (shareButton) {
            // Listener final do botão de compartilhamento
            shareButton.addEventListener('click', (event) => {
                event.preventDefault(); 
                uploadPost();
            });
        }
    });

  </script>
</body>
</html>
